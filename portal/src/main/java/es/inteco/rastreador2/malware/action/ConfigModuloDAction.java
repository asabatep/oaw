package es.inteco.rastreador2.malware.action;

import es.inteco.common.Constants;
import es.inteco.common.logging.Logger;
import es.inteco.common.properties.PropertiesManager;
import es.inteco.plugin.dao.DataBaseManager;
import es.inteco.rastreador2.malware.actionform.ConfigDForm;
import es.inteco.rastreador2.malware.dao.MalwareDao;
import es.inteco.rastreador2.malware.dao.MalwareHit;
import es.inteco.rastreador2.utils.CrawlerUtils;
import es.inteco.utils.FileUtils;
import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.upload.FormFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.sql.Connection;
import java.util.List;

import static es.inteco.common.Constants.CRAWLER_PROPERTIES;

/**
 * Clase InformesDispatchAction.
 * Action de Informes
 *
 * @author psanchez
 */
public class ConfigModuloDAction extends ConfigModuloAction {

    public ActionForward execute(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        // Marcamos el menú
        request.getSession().setAttribute(Constants.SUBMENU, Constants.SUBMENU_CONFIG_MALWARE_D);

        if (CrawlerUtils.hasAccess(request, "config.malware")) {
            String action = request.getParameter(Constants.ACTION);
            if (action != null) {
                if (action.equals(Constants.CONFIG)) {
                    return loadConfiguration(mapping, form, request, response);
                } else if (action.equals(Constants.EDIT)) {
                    return editLoad(mapping, form, request, response);
                } else if (action.equals(Constants.SUBMIT_EDIT)) {
                    if (isCancelled(request)) {
                        return mapping.findForward(Constants.VOLVER);
                    } else {
                        ConfigDForm configDForm = (ConfigDForm) form;
                        return editData(configDForm, mapping, request, response);
                    }
                }
            }
        } else {
            return mapping.findForward(Constants.NO_PERMISSION);
        }

        return null;
    }

    public ActionForward loadConfiguration(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        ConfigDForm configForm = loadData();
        request.setAttribute(Constants.CONFIG_FORM, configForm);

        return mapping.findForward(Constants.CONFIG);
    }

    public ActionForward editLoad(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        ConfigDForm configForm = (ConfigDForm) request.getSession().getAttribute(Constants.CONFIG_D_FORM);
        if (request.getSession().getAttribute(Constants.TYPE_LIST_FILE_WL) != null) {
            configForm.setCertWhiteList(((FormFile) request.getSession().getAttribute(Constants.TYPE_LIST_FILE_WL)).getFileName());
            configForm.setCertWhiteListEdit(true);
            request.getSession().removeAttribute(Constants.TYPE_LIST_FILE_WL);
        } else if (request.getSession().getAttribute(Constants.TYPE_LIST_FILE_BL) != null) {
            configForm.setCertBlackList(((FormFile) request.getSession().getAttribute(Constants.TYPE_LIST_FILE_BL)).getFileName());
            configForm.setCertBlackListEdit(true);
            request.getSession().removeAttribute(Constants.TYPE_LIST_FILE_BL);
        } else {
            configForm = loadData();
            request.getSession().setAttribute(Constants.CONFIG_D_FORM, configForm);
        }
        request.setAttribute(Constants.CONFIG_FORM, configForm);

        return mapping.findForward(Constants.EDIT);
    }

    public ActionForward editData(ConfigDForm configDForm, ActionMapping mapping, HttpServletRequest request, HttpServletResponse response) {
        PropertiesManager pmgr = new PropertiesManager();
        ActionErrors errors = configDForm.validate(mapping, request);
        if (errors == null || errors.isEmpty()) {
            Connection conn = null;
            try {
                conn = DataBaseManager.getConnection(pmgr.getValue(CRAWLER_PROPERTIES, "datasource.name.malware"));
                MalwareDao.updateModuleD(conn, configDForm, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.d.hit.id")));

                if (configDForm.isCertBlackListEdit()) {
                    FileUtils.moveFile(pmgr.getValue("malware.properties", "certificates.bl.file.path.tmp"),
                            pmgr.getValue("malware.properties", "certificates.bl.file.path"),
                            configDForm.getCertBlackList());
                }

                if (configDForm.isCertWhiteListEdit()) {
                    FileUtils.moveFile(pmgr.getValue("malware.properties", "certificates.wl.file.path.tmp"),
                            pmgr.getValue("malware.properties", "certificates.wl.file.path"),
                            configDForm.getCertWhiteList());
                }

                request.getSession().removeAttribute(Constants.CONFIG_D_FORM);
                return loadConfiguration(mapping, configDForm, request, response);
            } catch (Exception e) {
                Logger.putLog("Error al editar el módulo B", ConfigModuloBAction.class, Logger.LOG_LEVEL_ERROR, e);
            } finally {
                DataBaseManager.closeConnection(conn);
            }
        } else {
            saveErrors(request, errors);
            request.setAttribute(Constants.CONFIG_FORM, configDForm);
            return mapping.findForward(Constants.EDIT);
        }
        return null;

    }

    public ConfigDForm loadData() {
        ConfigDForm configForm = new ConfigDForm();

        Connection conn = null;
        PropertiesManager pmgr = new PropertiesManager();
        try {
            conn = DataBaseManager.getConnection(pmgr.getValue(CRAWLER_PROPERTIES, "datasource.name.malware"));

            MalwareHit globalHit = MalwareDao.getHitById(conn, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.d.hit.id")));
            configForm.setConfidence(globalHit.getConfidence().toString());
            configForm.setWeight(globalHit.getWeight().toString());

            List<MalwareHit> hits = MalwareDao.getHitsByModule(conn, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.d.hit.id")));
            for (MalwareHit hit : hits) {
                if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "javascript.hit.id"))) {
                    configForm.setJavascriptConfidence(hit.getConfidence().toString());
                    configForm.setJavascriptWeight(hit.getWeight().toString());
                } else if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "certificados.wl.hit.id"))) {
                    configForm.setCertWhiteListConfidence(hit.getConfidence().toString());
                    configForm.setCertWhiteListWeight(hit.getWeight().toString());
                    configForm.setCertWhiteList(hit.getValue().substring(pmgr.getValue("malware.properties", "certificates.wl.file.path").length()));
                } else if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "certificados.bl.hit.id"))) {
                    configForm.setCertBlackListConfidence(hit.getConfidence().toString());
                    configForm.setCertBlackListWeight(hit.getWeight().toString());
                    configForm.setCertBlackList(hit.getValue().substring(pmgr.getValue("malware.properties", "certificates.bl.file.path").length()));
                } else if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "actionscript.hit.id"))) {
                    configForm.setActionscriptConfidence(hit.getConfidence().toString());
                    configForm.setActionscriptWeight(hit.getWeight().toString());
                }
            }
        } catch (Exception e) {
            Logger.putLog("Error al cargar la configuración del módulo D", ConfigModuloDAction.class, Logger.LOG_LEVEL_ERROR, e);
        } finally {
            DataBaseManager.closeConnection(conn);
        }

        return configForm;
    }

}
