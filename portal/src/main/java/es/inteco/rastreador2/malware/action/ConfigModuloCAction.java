package es.inteco.rastreador2.malware.action;

import es.inteco.common.Constants;
import es.inteco.common.logging.Logger;
import es.inteco.common.properties.PropertiesManager;
import es.inteco.plugin.dao.DataBaseManager;
import es.inteco.rastreador2.malware.actionform.ConfigCForm;
import es.inteco.rastreador2.malware.dao.MalwareDao;
import es.inteco.rastreador2.malware.dao.MalwareHit;
import es.inteco.rastreador2.utils.CrawlerUtils;
import es.inteco.utils.FileUtils;
import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.upload.FormFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.sql.Connection;
import java.util.List;

import static es.inteco.common.Constants.CRAWLER_PROPERTIES;

/**
 * Clase InformesDispatchAction.
 * Action de Informes
 *
 * @author psanchez
 */
public class ConfigModuloCAction extends ConfigModuloAction {

    public ActionForward execute(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        // Marcamos el menú
        request.getSession().setAttribute(Constants.SUBMENU, Constants.SUBMENU_CONFIG_MALWARE_C);

        if (CrawlerUtils.hasAccess(request, "config.malware")) {
            String action = request.getParameter(Constants.ACTION);
            if (action != null) {
                if (action.equals(Constants.CONFIG)) {
                    return loadConfiguration(mapping, form, request, response);
                } else if (action.equals(Constants.EDIT)) {
                    return editLoad(mapping, form, request, response);
                } else if (action.equals(Constants.SUBMIT_EDIT)) {
                    if (isCancelled(request)) {
                        return mapping.findForward(Constants.VOLVER);
                    } else {
                        ConfigCForm configCForm = (ConfigCForm) form;
                        return editData(configCForm, mapping, request, response);
                    }
                }
            }
        } else {
            return mapping.findForward(Constants.NO_PERMISSION);
        }

        return null;
    }

    public ActionForward loadConfiguration(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        ConfigCForm configForm = loadData();
        request.setAttribute(Constants.CONFIG_FORM, configForm);

        return mapping.findForward(Constants.CONFIG);
    }

    public ConfigCForm loadData() {

        ConfigCForm configForm = new ConfigCForm();

        Connection conn = null;
        PropertiesManager pmgr = new PropertiesManager();

        try {
            conn = DataBaseManager.getConnection(pmgr.getValue(CRAWLER_PROPERTIES, "datasource.name.malware"));

            MalwareHit globalHit = MalwareDao.getHitById(conn, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.c.hit.id")));
            configForm.setConfidence(globalHit.getConfidence().toString());
            configForm.setWeight(globalHit.getWeight().toString());

            List<MalwareHit> hits = MalwareDao.getHitsByModule(conn, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.c.hit.id")));
            for (MalwareHit hit : hits) {
                if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "dominio.wl.hit.id"))) {
                    configForm.setWhiteList(hit.getValue().substring(pmgr.getValue("malware.properties", "domains.wl.file.path").length()));
                    configForm.setWhiteListConfidence(hit.getWeight().toString());
                    configForm.setWhiteListWeight(hit.getConfidence().toString());
                } else if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "dominio.bl.hit.id"))) {
                    configForm.setBlackList(hit.getValue().substring(pmgr.getValue("malware.properties", "domains.bl.file.path").length()));
                    configForm.setBlackListConfidence(hit.getWeight().toString());
                    configForm.setBlackListWeight(hit.getConfidence().toString());
                }
            }
        } catch (Exception e) {
            Logger.putLog("Error al cargar la configuración del módulo C", ConfigModuloCAction.class, Logger.LOG_LEVEL_ERROR, e);
        } finally {
            DataBaseManager.closeConnection(conn);
        }

        return configForm;
    }

    public ActionForward editLoad(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        ConfigCForm configForm = (ConfigCForm) request.getSession().getAttribute(Constants.CONFIG_C_FORM);
        if (request.getSession().getAttribute(Constants.TYPE_LIST_FILE_WL) != null) {
            configForm.setWhiteList(((FormFile) request.getSession().getAttribute(Constants.TYPE_LIST_FILE_WL)).getFileName());
            configForm.setWhiteListEdit(true);
            request.getSession().removeAttribute(Constants.TYPE_LIST_FILE_WL);
        } else if (request.getSession().getAttribute(Constants.TYPE_LIST_FILE_BL) != null) {
            configForm.setBlackList(((FormFile) request.getSession().getAttribute(Constants.TYPE_LIST_FILE_BL)).getFileName());
            configForm.setBlackListEdit(true);
            request.getSession().removeAttribute(Constants.TYPE_LIST_FILE_BL);
        } else {
            configForm = loadData();
            request.getSession().setAttribute(Constants.CONFIG_C_FORM, configForm);
        }
        request.setAttribute(Constants.CONFIG_FORM, configForm);

        return mapping.findForward(Constants.EDIT);
    }

    public ActionForward editData(ConfigCForm configCForm, ActionMapping mapping, HttpServletRequest request, HttpServletResponse response) {
        PropertiesManager pmgr = new PropertiesManager();
        ActionErrors errors = configCForm.validate(mapping, request);
        if (errors == null || errors.isEmpty()) {
            Connection conn = null;
            try {
                conn = DataBaseManager.getConnection(pmgr.getValue(CRAWLER_PROPERTIES, "datasource.name.malware"));
                MalwareDao.updateModuleC(conn, configCForm, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.c.hit.id")));

                if (configCForm.isBlackListEdit()) {
                    FileUtils.moveFile(pmgr.getValue("malware.properties", "domains.bl.file.path.tmp"),
                            pmgr.getValue("malware.properties", "domains.bl.file.path"),
                            configCForm.getBlackList());
                }

                if (configCForm.isWhiteListEdit()) {
                    FileUtils.moveFile(pmgr.getValue("malware.properties", "domains.wl.file.path.tmp"),
                            pmgr.getValue("malware.properties", "domains.wl.file.path"),
                            configCForm.getWhiteList());
                }

                request.getSession().removeAttribute(Constants.CONFIG_C_FORM);
                return loadConfiguration(mapping, configCForm, request, response);
            } catch (Exception e) {
                Logger.putLog("Error al editar el módulo C", ConfigModuloCAction.class, Logger.LOG_LEVEL_ERROR, e);
            } finally {
                DataBaseManager.closeConnection(conn);
            }
        } else {
            saveErrors(request, errors);
            request.setAttribute(Constants.CONFIG_FORM, configCForm);
            return mapping.findForward(Constants.EDIT);
        }
        return null;
    }
}
