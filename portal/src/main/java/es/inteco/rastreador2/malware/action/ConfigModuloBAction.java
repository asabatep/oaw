package es.inteco.rastreador2.malware.action;

import es.inteco.common.Constants;
import es.inteco.common.logging.Logger;
import es.inteco.common.properties.PropertiesManager;
import es.inteco.plugin.dao.DataBaseManager;
import es.inteco.rastreador2.malware.actionform.ConfigBForm;
import es.inteco.rastreador2.malware.dao.MalwareDao;
import es.inteco.rastreador2.malware.dao.MalwareHit;
import es.inteco.rastreador2.utils.CrawlerUtils;
import es.inteco.utils.FileUtils;
import org.apache.struts.action.ActionErrors;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.upload.FormFile;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.sql.Connection;
import java.util.List;

import static es.inteco.common.Constants.CRAWLER_PROPERTIES;

/**
 * Clase InformesDispatchAction.
 * Action de Informes
 *
 * @author psanchez
 */
public class ConfigModuloBAction extends ConfigModuloAction {

    public ActionForward execute(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {

        // Marcamos el menú
        request.getSession().setAttribute(Constants.SUBMENU, Constants.SUBMENU_CONFIG_MALWARE_B);

        if (CrawlerUtils.hasAccess(request, "config.malware")) {
            String action = request.getParameter(Constants.ACTION);
            if (action != null) {
                if (action.equals(Constants.CONFIG)) {
                    return loadConfiguration(mapping, form, request, response);
                } else if (action.equals(Constants.EDIT)) {
                    return editLoad(mapping, form, request, response);
                } else if (action.equals(Constants.SUBMIT_EDIT)) {
                    if (isCancelled(request)) {
                        return mapping.findForward(Constants.VOLVER);
                    } else {
                        ConfigBForm configBForm = (ConfigBForm) form;
                        return editData(configBForm, mapping, request, response);
                    }
                }
            }
        } else {
            return mapping.findForward(Constants.NO_PERMISSION);
        }

        return null;
    }

    public ActionForward loadConfiguration(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        ConfigBForm configForm = loadData();
        request.setAttribute(Constants.CONFIG_FORM, configForm);

        return mapping.findForward(Constants.CONFIG);
    }

    public ConfigBForm loadData() {
        ConfigBForm configForm = new ConfigBForm();

        Connection conn = null;
        PropertiesManager pmgr = new PropertiesManager();

        try {
            conn = DataBaseManager.getConnection(pmgr.getValue(CRAWLER_PROPERTIES, "datasource.name.malware"));

            MalwareHit globalHit = MalwareDao.getHitById(conn, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.b.hit.id")));
            configForm.setConfidence(globalHit.getConfidence().toString());
            configForm.setWeight(globalHit.getWeight().toString());

            List<MalwareHit> hits = MalwareDao.getHitsByModule(conn, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.b.hit.id")));
            for (MalwareHit hit : hits) {
                if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "ofuscado.hit.id"))) {
                    configForm.setObfuscatedConfidence(hit.getConfidence().toString());
                    configForm.setObfuscatedWeight(hit.getWeight().toString());
                } else if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "multimedia.hit.id"))) {
                    configForm.setMultimediaString(hit.getValue().substring(pmgr.getValue("malware.properties", "mime.type.file.path").length()));
                    configForm.setMultimediaConfidence(hit.getConfidence().toString());
                    configForm.setMultimediaWeight(hit.getWeight().toString());
                } else if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "terminos.b.hit.id"))) {
                    configForm.setTermsConfidence(hit.getConfidence().toString());
                    configForm.setTermsWeight(hit.getWeight().toString());
                } else if (hit.getId() == Integer.parseInt(pmgr.getValue("malware.properties", "dom.hit.id"))) {
                    configForm.setDomConfidence(hit.getConfidence().toString());
                    configForm.setDomWeight(hit.getWeight().toString());
                }
            }
        } catch (Exception e) {
            Logger.putLog("Error al cargar la configuración del módulo B", ConfigModuloBAction.class, Logger.LOG_LEVEL_ERROR, e);
        } finally {
            DataBaseManager.closeConnection(conn);
        }

        return configForm;
    }

    public ActionForward editLoad(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        ConfigBForm configForm = loadData();
        if (request.getSession().getAttribute(Constants.MULTIMEDIA_FILE) != null) {
            configForm.setMultimediaString(((FormFile) request.getSession().getAttribute(Constants.MULTIMEDIA_FILE)).getFileName());
            configForm.setMultimediaEdit(true);
            request.getSession().removeAttribute(Constants.MULTIMEDIA_FILE);
        }
        request.setAttribute(Constants.CONFIG_FORM, configForm);

        return mapping.findForward(Constants.EDIT);
    }

    public ActionForward editData(ConfigBForm configBForm, ActionMapping mapping, HttpServletRequest request, HttpServletResponse response) {
        PropertiesManager pmgr = new PropertiesManager();
        ActionErrors errors = configBForm.validate(mapping, request);
        if (errors == null || errors.isEmpty()) {
            Connection conn = null;
            try {
                conn = DataBaseManager.getConnection(pmgr.getValue(CRAWLER_PROPERTIES, "datasource.name.malware"));
                MalwareDao.updateModuleB(conn, configBForm, Integer.parseInt(pmgr.getValue("malware.properties", "modulo.b.hit.id")));

                if (configBForm.isMultimediaEdit()) {
                    FileUtils.moveFile(pmgr.getValue("malware.properties", "mime.type.file.path.tmp"),
                            pmgr.getValue("malware.properties", "mime.type.file.path"),
                            configBForm.getMultimediaString());
                }

                return loadConfiguration(mapping, configBForm, request, response);
            } catch (Exception e) {
                Logger.putLog("Error al editar el módulo B", ConfigModuloBAction.class, Logger.LOG_LEVEL_ERROR, e);
            } finally {
                DataBaseManager.closeConnection(conn);
            }
        } else {
            saveErrors(request, errors);
            request.setAttribute(Constants.CONFIG_FORM, configBForm);
            return mapping.findForward(Constants.EDIT);
        }
        return null;
    }

}
