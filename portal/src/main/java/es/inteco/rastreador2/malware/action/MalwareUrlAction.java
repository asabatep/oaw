package es.inteco.rastreador2.malware.action;

import es.inteco.common.Constants;
import es.inteco.common.logging.Logger;
import es.inteco.common.properties.PropertiesManager;
import es.inteco.plugin.dao.DataBaseManager;
import es.inteco.rastreador2.dao.rastreo.RastreoDAO;
import es.inteco.rastreador2.malware.actionform.ResultsByUrlMalware;
import es.inteco.rastreador2.malware.actionform.UrlSearchForm;
import es.inteco.rastreador2.malware.dao.MalwareDao;
import es.inteco.rastreador2.malware.dao.MalwareHit;
import es.inteco.rastreador2.malware.utils.MalwareUtils;
import es.inteco.rastreador2.pdf.ExportAction;
import es.inteco.rastreador2.utils.CrawlerUtils;
import es.inteco.rastreador2.utils.Pagination;
import org.apache.struts.action.*;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.sql.Connection;
import java.util.List;

/**
 * Clase InformesDispatchAction.
 * Action de Informes
 *
 * @author psanchez
 */
public class MalwareUrlAction extends Action {

    public ActionForward execute(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        if (CrawlerUtils.hasAccess(request, "show.crawler.results")) {
            Connection c = null;
            try {
                c = DataBaseManager.getConnection();
                String user = (String) request.getSession().getAttribute(Constants.USER);
                long idRastreo = Long.parseLong(request.getParameter(Constants.ID_RASTREO));
                //Comprobamos que el usuario esta asociado con los resultados de los rastreos que quiere recuperar
                if (RastreoDAO.crawlerToUser(c, idRastreo, user) || RastreoDAO.crawlerToClientAccount(c, idRastreo, user)) {
                    if (request.getParameter(Constants.ACCION).equals(Constants.RESULTS_BY_URL)) {
                        return getResultsByUrl(mapping, form, request, response);
                    } else if (request.getParameter(Constants.ACCION).equals(Constants.URL_DETAIL)) {
                        return getUrlDetail(mapping, form, request, response);
                    } else if (request.getParameter(Constants.ACCION).equals(Constants.DELETE_RESULT)) {
                        return deleteResult(mapping, form, request, response);
                    } else if (request.getParameter(Constants.ACCION).equals(Constants.DELETE_CONFIRMATION)) {
                        return deleteConfirmation(mapping, form, request, response);
                    } else if (request.getParameter(Constants.ACCION).equals(Constants.EXPORT_CSV)) {
                        return exportCSV(mapping, form, request, response);
                    } else if (request.getParameter(Constants.ACCION).equals(Constants.EXPORT_PDF)) {
                        return exportPDF(mapping, form, request, response);
                    }
                }
            } catch (Exception e) {
                Logger.putLog("Excepcion: ", MalwareUrlAction.class, Logger.LOG_LEVEL_ERROR, e);
                return mapping.findForward(Constants.ERROR);
            } finally {
                DataBaseManager.closeConnection(c);
            }
        } else {
            return mapping.findForward(Constants.NO_PERMISSION);
        }

        return null;
    }

    public ActionForward getResultsByUrl(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {

        UrlSearchForm urlSearchForm = (UrlSearchForm) form;
        ActionErrors errors = urlSearchForm.validate(mapping, request);
        if (errors != null && !errors.isEmpty()) {
            saveErrors(request.getSession(), errors);
            long idExecution = Long.parseLong(request.getParameter(Constants.ID));
            long idRastreo = Long.parseLong(request.getParameter(Constants.ID_RASTREO));
            ActionForward forward = new ActionForward(mapping.getInputForward());
            forward.setPath(forward.getPath() + "&" + Constants.ID_RASTREO + "=" + idRastreo + "&" + Constants.ID + "=" + idExecution);
            forward.setRedirect(true);
            return forward;
        } else {
            Connection c = null;
            try {
                c = DataBaseManager.getConnection();

                long idExecution = Long.parseLong(request.getParameter(Constants.ID));

                int numResults = MalwareDao.countResultsByUrl(c, idExecution, urlSearchForm);
                int pagina = Pagination.getPage(request, Constants.PAG_PARAM);

                List<ResultsByUrlMalware> results = MalwareDao.getResultsByUrl(c, idExecution, urlSearchForm, (pagina - 1));
                request.setAttribute(Constants.RESULTS_BY_URL, results);
                request.setAttribute(Constants.LIST_PAGE_LINKS, Pagination.createPagination(request, numResults, pagina));

                return mapping.findForward(Constants.RESULTS_BY_URL);
            } catch (Exception e) {
                Logger.putLog("Excepcion: ", MalwareUrlAction.class, Logger.LOG_LEVEL_ERROR, e);
                return mapping.findForward(Constants.ERROR);
            } finally {
                DataBaseManager.closeConnection(c);
            }
        }
    }

    public ActionForward getUrlDetail(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        PropertiesManager pmgr = new PropertiesManager();
        Connection c = null;

        try {
            c = DataBaseManager.getConnection();

            String[] idHits = {pmgr.getValue("malware.properties", "modulo.a.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.b.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.c.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.d.hit.id")};

            List<MalwareHit> modules = MalwareUtils.getHitsByUrl(c, idHits);

            // Añadimos las ocurrencias de los términos en aquellos hits que tengan
            String urlHash = request.getParameter(Constants.URL_HASH);
            long idExecution = Long.parseLong(request.getParameter(Constants.ID));
            MalwareUtils.addTermOccurrences(c, modules, idExecution, urlHash);

            request.setAttribute(Constants.MODULES, modules);

            request.setAttribute(Constants.URL, MalwareDao.getUrlByHash(c, urlHash));

            return mapping.findForward(Constants.URL_DETAIL);

        } catch (Exception e) {
            Logger.putLog("Excepcion: ", MalwareUrlAction.class, Logger.LOG_LEVEL_ERROR, e);
            return mapping.findForward(Constants.ERROR);
        } finally {
            DataBaseManager.closeConnection(c);
        }
    }

    public ActionForward deleteResult(ActionMapping mapping, ActionForm form,
                                      HttpServletRequest request, HttpServletResponse response) throws Exception {

        Connection c = null;

        long idExecution = Long.parseLong(request.getParameter(Constants.ID));
        String urlHash = request.getParameter(Constants.URL_HASH);

        try {
            c = DataBaseManager.getConnection();

            MalwareDao.deleteResult(c, idExecution, urlHash);
        } catch (Exception e) {
            Logger.putLog("Excepcion: ", MalwareUrlAction.class, Logger.LOG_LEVEL_ERROR, e);
            return mapping.findForward(Constants.ERROR);
        } finally {
            DataBaseManager.closeConnection(c);
        }

        return getResultsByUrl(mapping, form, request, response);
    }

    public ActionForward deleteConfirmation(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {

        Connection c = null;

        try {
            c = DataBaseManager.getConnection();

            String urlHash = request.getParameter(Constants.URL_HASH);
            request.setAttribute(Constants.URL, MalwareDao.getUrlByHash(c, urlHash));

        } catch (Exception e) {
            Logger.putLog("Excepcion: ", MalwareUrlAction.class, Logger.LOG_LEVEL_ERROR, e);
            return mapping.findForward(Constants.ERROR);
        } finally {
            DataBaseManager.closeConnection(c);
        }

        return mapping.findForward(Constants.DELETE_CONFIRMATION);
    }

    public ActionForward exportCSV(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        PropertiesManager pmgr = new PropertiesManager();
        Connection c = null;

        String path = null;

        try {
            c = DataBaseManager.getConnection();

            String[] idHits = {pmgr.getValue("malware.properties", "modulo.a.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.b.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.c.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.d.hit.id")};

            List<MalwareHit> modules = MalwareUtils.getHitsByUrl(c, idHits);

            // Añadimos las ocurrencias de los términos en aquellos hits que tengan
            String urlHash = request.getParameter(Constants.URL_HASH);
            long idExecution = Long.parseLong(request.getParameter(Constants.ID));
            MalwareUtils.addTermOccurrences(c, modules, idExecution, urlHash);

            path = pmgr.getValue("malware.properties", "csv.export.tmp") + System.currentTimeMillis() + ".csv";
            MalwareUtils.writeUrlCSVFile(path, modules, request);
        } catch (Exception e) {
            Logger.putLog("Excepcion: ", MalwareUrlAction.class, Logger.LOG_LEVEL_ERROR, e);
            return mapping.findForward(Constants.ERROR);
        } finally {
            DataBaseManager.closeConnection(c);
        }

        try {
            CrawlerUtils.returnFile(path, response, "text/comma-separated-values", true);
        } catch (Exception e) {
            Logger.putLog("Exception al devolver el PDF", ExportAction.class, Logger.LOG_LEVEL_ERROR, e);
        }

        return null;
    }

    public ActionForward exportPDF(ActionMapping mapping, ActionForm form, HttpServletRequest request, HttpServletResponse response) throws Exception {
        PropertiesManager pmgr = new PropertiesManager();
        Connection c = null;
        Connection systemConn = null;

        String path = null;

        try {
            c = DataBaseManager.getConnection();

            systemConn = DataBaseManager.getConnection();

            String[] idHits = {pmgr.getValue("malware.properties", "modulo.a.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.b.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.c.hit.id"),
                    pmgr.getValue("malware.properties", "modulo.d.hit.id")};

            List<MalwareHit> modules = MalwareUtils.getHitsByUrl(c, idHits);

            // Añadimos las ocurrencias de los términos en aquellos hits que tengan
            String urlHash = request.getParameter(Constants.URL_HASH);
            long idExecution = Long.parseLong(request.getParameter(Constants.ID));
            long idCrawling = Long.parseLong(request.getParameter(Constants.ID_RASTREO));
            MalwareUtils.addTermOccurrences(c, modules, idExecution, urlHash);

            path = pmgr.getValue("malware.properties", "pdf.export.tmp") + System.currentTimeMillis() + ".pdf";
            MalwareUtils.writeUrlPDFFile(path, modules, request, RastreoDAO.recuperarNombreRastreo(systemConn, idCrawling), MalwareDao.getUrlByHash(c, urlHash));

        } catch (Exception e) {
            Logger.putLog("Excepcion: ", MalwareUrlAction.class, Logger.LOG_LEVEL_ERROR, e);
            return mapping.findForward(Constants.ERROR);
        } finally {
            DataBaseManager.closeConnection(c);
            DataBaseManager.closeConnection(systemConn);
        }

        try {
            CrawlerUtils.returnFile(path, response, "application/pdf", true);
        } catch (Exception e) {
            Logger.putLog("Exception al devolver el PDF", ExportAction.class, Logger.LOG_LEVEL_ERROR, e);
        }

        return null;
    }
}
